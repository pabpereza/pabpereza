---
title: L칩gica de Control
sidebar_label: 6. Control
---

# L칩gica de control 游

A침adiendo inteligencia a nuestras automatizaciones.

:::info Video pendiente de grabaci칩n
:::

## 6.1. Condicionales (`when`)

A veces quieres que una tarea se ejecute solo en circunstancias espec칤ficas. Para esto usamos la cl치usula `when`.

### 游뛁 La analog칤a: el portero de discoteca
Imagina un portero en la entrada de un club. No deja pasar a todo el mundo; eval칰a condiciones:
*   쯃levas zapatillas? -> **No pasas** (Skipped).
*   쯃levas zapatos? -> **Pasas** (Executed).

En Ansible, el portero es `when`.

### Flujo de decisi칩n

```mermaid
flowchart TD
    A[Inicio Tarea] --> B{쮺ondici칩n Cumplida?}
    B -- S칤 (True) --> C[Ejecutar Tarea]
    B -- No (False) --> D[Saltar Tarea \n(Skipped)]
    C --> E[Siguiente Tarea]
    D --> E
    
    style B fill:#f9f,stroke:#333
    style D fill:#ccc,stroke:#333,stroke-dasharray: 5 5
```

### 游빍 Pr치ctica: decisi칩n por sistema operativo
El caso de uso m치s com칰n: instalar paquetes con el gestor adecuado seg칰n la distribuci칩n de Linux.

```yaml
tasks:
  - name: Instalar Apache en Debian/Ubuntu
    apt:
      name: apache2
      state: present
    when: ansible_os_family == "Debian"

  - name: Instalar Apache en RedHat/CentOS
    yum:
      name: httpd
      state: present
    when: ansible_os_family == "RedHat"
```

Tambi칠n puedes combinar condiciones con `and` y `or`:
```yaml
when: ansible_os_family == "Debian" and ansible_memtotal_mb > 1024
```

---

## 6.2. Bucles (`loop`)

En programaci칩n existe el principio **DRY (Don't Repeat Yourself)**. En lugar de escribir 5 tareas id칠nticas para crear 5 usuarios, escribimos una sola tarea que se repite 5 veces.

### 游낈 La Analog칤a: La Cadena de Montaje
Imagina un brazo rob칩tico en una f치brica de botellas.
*   **Mal m칠todo:** Tienes 5 robots, cada uno pone un tap칩n a una sola botella.
*   **Buen m칠todo (Bucle):** Tienes 1 robot que repite la acci칩n "poner tap칩n" mientras pasen botellas por la cinta.

### Sintaxis Moderna: `loop` vs `with_items`
Antiguamente se usaba `with_items`. Aunque lo ver치s en muchos tutoriales viejos, **la forma moderna y recomendada es `loop`**.

### 游빍 Pr치ctica 1: Lista Simple
Instalar m칰ltiples paquetes en una sola pasada.

```yaml
- name: Instalar herramientas esenciales
  apt:
    name: "{{ item }}"
    state: present
  loop:
    - git
    - curl
    - vim
    - htop
```
*Nota: La variable m치gica `{{ item }}` representa el valor actual de la iteraci칩n.*

### 游빍 Pr치ctica 2: Lista de Diccionarios (Complejo)
Crear usuarios con diferentes atributos.

```yaml
- name: Crear usuarios desarrolladores
  user:
    name: "{{ item.nombre }}"
    groups: "{{ item.grupo }}"
    shell: /bin/bash
  loop:
    - { nombre: 'ana', grupo: 'admin' }
    - { nombre: 'pablo', grupo: 'devops' }
    - { nombre: 'luis', grupo: 'developers' }
```

---

## 6.3. Handlers (Manejadores de Eventos)

Los Handlers son tareas especiales que **solo se ejecutan si son notificadas**. Son ideales para reiniciar servicios cuando cambia un archivo de configuraci칩n.

### 游뚿 La Analog칤a: La Alarma de Incendios
Una alarma de incendios no est치 sonando todo el d칤a (eso ser칤a molesto y romper칤a el servicio).
*   La alarma est치 "a la espera" (Handler).
*   Solo suena SI el sensor de humo detecta fuego (Change + Notify).
*   Si no hay fuego, la alarma sigue en silencio.

### Caracter칤sticas Clave
1.  **Son perezosos:** Solo act칰an si una tarea tiene estado `changed`.
2.  **Se ejecutan al final:** Por defecto, esperan a que termine todo el Play para ejecutarse (para evitar reiniciar Apache 5 veces si cambiaste 5 archivos; solo se reinicia una vez al final).

### Flujo de Ejecuci칩n

```mermaid
sequenceDiagram
    participant T as Tarea (Config Nginx)
    participant A as Ansible Engine
    participant H as Handler (Restart Nginx)

    T->>A: Ejecutar cambio en archivo
    alt Hubo cambios (Changed)
        A->>T: Marca como "Changed"
        T->>H: Notify "Restart Nginx"
        Note right of H: (Se encola para despu칠s)
    else Sin cambios (OK)
        A->>T: Marca como "OK"
        T--xH: No notifica nada
    end
    
    Note over A,H: ...Se ejecutan el resto de tareas...
    
    Note over H: AL FINAL DEL PLAY
    H->>H: Se ejecuta (si fue notificado)
```

### 游빍 Pr치ctica: Configuraci칩n de Nginx

```yaml
tasks:
  - name: Copiar configuraci칩n de Nginx
    template:
      src: nginx.conf.j2
      dest: /etc/nginx/nginx.conf
    notify: Reiniciar Nginx  # <--- El disparador

  - name: Otra tarea cualquiera
    debug:
      msg: "Haciendo otras cosas..."

handlers:  # <--- Secci칩n separada al final
  - name: Reiniciar Nginx
    service:
      name: nginx
      state: restarted
```

**Escenario:**
1.  Ejecutas el Playbook. El archivo cambia. Se notifica al Handler.
2.  Se ejecuta la tarea de debug.
3.  Termina el Play. **Se reinicia Nginx.**
4.  Vuelves a ejecutar el Playbook inmediatamente. El archivo NO cambia (Idempotencia). **El Handler NO se ejecuta.**

## Resumen
Con **Conditionals**, **Loops** y **Handlers**, tus Playbooks dejan de ser simples listas de la compra y se convierten en programas inteligentes capaces de adaptarse al entorno y gestionar el ciclo de vida de tus servicios eficientemente.
