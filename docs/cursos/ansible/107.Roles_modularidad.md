---
title: Roles y Modularidad
sidebar_label: 7. Roles
---

# Roles y modularidad üì¶

Organiza tu c√≥digo como un profesional usando la estructura de roles.

:::info Video pendiente de grabaci√≥n
:::

## 7.1. Introducci√≥n: ¬øpor qu√© roles?

Hasta ahora, hemos escrito playbooks que son listas largas de tareas. Esto funciona bien para 10 o 20 tareas, pero ¬øqu√© pasa cuando tienes 500? ¬øO cuando quieres configurar Nginx en 10 proyectos diferentes?

### üçù La analog√≠a: c√≥digo espagueti vs. librer√≠as
Imagina un libro de 1000 p√°ginas sin cap√≠tulos ni √≠ndice. Eso es un playbook gigante. Es dif√≠cil de leer, dif√≠cil de mantener y casi imposible de reutilizar.

Los **roles** son como las **"habilidades" en un videojuego**.
*   Tienes un personaje (servidor).
*   Quieres que sepa hacer magia (servidor web).
*   En lugar de ense√±arle los movimientos uno a uno cada vez, le equipas el libro de hechizos "Mago de Fuego" (rol `webserver`).
*   ¬°Pum! Ahora sabe lanzar bolas de fuego (instalar nginx, configurar vhosts, abrir puertos) autom√°ticamente.

## 7.2. La estructura de un rol

Ansible espera una estructura de carpetas muy espec√≠fica. Si la respetas, la magia ocurre sola (autoloading).

### üå≥ Anatom√≠a visual

```mermaid
mindmap
  root((Rol: apache_simple))
    tasks
      main.yml (El coraz√≥n: las acciones)
    handlers
      main.yml (Reinicios y eventos)
    templates
      index.html.j2 (Archivos din√°micos)
    files
      logo.png (Archivos est√°ticos)
    vars
      main.yml (Variables internas, alta prioridad)
    defaults
      main.yml (Variables por defecto, baja prioridad)
    meta
      main.yml (Dependencias y autor)
```

### Diccionario de carpetas
*   **`tasks/`**: Aqu√≠ van los m√≥dulos (`apt`, `copy`, `service`). Es lo que antes ten√≠as en la secci√≥n `tasks:` del playbook.
*   **`handlers/`**: Los disparadores (`restart nginx`).
*   **`templates/`**: Tus archivos `.j2`.
*   **`files/`**: Archivos que se copian tal cual (certificados, im√°genes).
*   **`defaults/`**: Variables con la prioridad **m√°s baja**. Est√°n hechas para ser sobrescritas f√°cilmente por el usuario del rol.
*   **`vars/`**: Variables con prioridad alta. √ösalas para constantes que rara vez cambian.

---

## 7.3. Manos a la obra: creando tu primer rol

Vamos a refactorizar. Tomaremos el "c√≥digo espagueti" de un servidor web y lo convertiremos en un rol elegante.

### Paso 1: inicializar la estructura
Ansible tiene un comando para crear el esqueleto por ti:

```bash
ansible-galaxy init apache_simple
```

### Paso 2: mover las piezas (refactorizaci√≥n)

Supongamos que ten√≠as este playbook antiguo:

```yaml
# old_playbook.yml (espagueti) ‚ùå
- hosts: webservers
  vars:
    http_port: 80
  tasks:
    - name: Instalar Apache
      apt: name=apache2 state=present
    - name: Copiar config
      template: src=templates/httpd.conf.j2 dest=/etc/apache2/httpd.conf
      notify: Reiniciar Apache
  handlers:
    - name: Reiniciar Apache
      service: name=apache2 state=restarted
```

Ahora, "descuartizamos" este archivo y ponemos cada cosa en su lugar dentro de la carpeta `apache_simple/`:

**1. `roles/apache_simple/tasks/main.yml`**
```yaml
---
- name: Instalar Apache
  apt:
    name: apache2
    state: present

- name: Copiar config
  template:
    src: httpd.conf.j2  # Nota: Ya no hace falta poner "templates/" delante
    dest: /etc/apache2/httpd.conf
  notify: Reiniciar Apache
```

**2. `roles/apache_simple/handlers/main.yml`**
```yaml
---
- name: Reiniciar Apache
  service:
    name: apache2
    state: restarted
```

**3. `roles/apache_simple/defaults/main.yml`**
```yaml
---
http_port: 80
```

### Paso 3: el resultado final (limpio y profesional)

Tu playbook principal (`site.yml`) ahora queda as√≠ de minimalista:

```yaml
# site.yml (modular) ‚úÖ
- hosts: webservers
  roles:
    - apache_simple
```

¬°De 15 l√≠neas a 3! Y lo mejor: puedes usar `apache_simple` en cualquier otro proyecto simplemente copiando la carpeta.

---

## 7.4. Ansible galaxy y collections

No reinventes la rueda. Probablemente alguien ya ha creado el rol perfecto para instalar Docker, Kubernetes o MySQL.

### üåå Ansible galaxy (el "app store")
Es el repositorio oficial de contenido comunitario.

*   **Buscar roles:** `ansible-galaxy search elasticsearch`
*   **Instalar un rol:** `ansible-galaxy install geerlingguy.elasticsearch`

### üì¶ Content collections (el nuevo est√°ndar)
Antiguamente, Galaxy solo ten√≠a roles. Ahora, con la complejidad de la nube, usamos **collections**.
Una collection es un paquete que incluye: **roles + m√≥dulos + plugins**.

Por ejemplo, la collection `amazon.aws` incluye m√≥dulos para EC2, S3, Lambda, etc.

#### Comandos esenciales

```bash
# Instalar una colecci√≥n
ansible-galaxy collection install amazon.aws

# Listar lo que tienes instalado
ansible-galaxy collection list
```

#### Usando collections en un playbook
```yaml
- hosts: localhost
  collections:
    - amazon.aws  # Declaramos que usaremos esta colecci√≥n
  tasks:
    - name: Crear instancia EC2
      ec2_instance:  # M√≥dulo que viene dentro de la colecci√≥n
        instance_type: t2.micro
```

## Resumen
1.  **Divide y vencer√°s:** Usa roles para separar responsabilidades.
2.  **Estandariza:** Respeta la estructura de carpetas (`tasks`, `vars`, `templates`) para que cualquiera entienda tu c√≥digo.
3.  **Reutiliza:** Antes de escribir c√≥digo, busca en Ansible Galaxy. Si tienes que escribirlo, hazlo pensando en que sea un rol gen√©rico para el futuro.
