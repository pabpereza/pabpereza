---
title: Seguridad y Templating
sidebar_label: 8. Seguridad y templating
slug: seguridad-templating-ansible
---

# Seguridad y Templating üîí

Gesti√≥n de secretos y configuraci√≥n din√°mica de archivos.

:::info Video pendiente de grabaci√≥n
:::

## 8.1. Ansible Vault: Protegiendo tus Secretos

### üö´ El Problema: Secretos en Texto Plano
Subir contrase√±as, claves API o tokens privados a GitHub en texto plano es el pecado capital de DevOps. Si tu repositorio es p√∫blico, te hackear√°n en minutos. Si es privado, cualquier persona con acceso al c√≥digo (becarios, auditores) podr√° ver las claves de producci√≥n.

### üîê La Analog√≠a: La Caja Fuerte Viajera
Imagina que tienes que enviar documentos confidenciales por correo. No los metes en un sobre transparente.
*   **Ansible Vault** es una **caja fuerte digital**.
*   Metes tus secretos dentro (`secrets.yml`).
*   La caja fuerte viaja con tu c√≥digo (se sube al repositorio), pero est√° cerrada.
*   Solo quien tenga la combinaci√≥n (contrase√±a del Vault) puede abrirla para usar los secretos.

### Flujo de Desencriptaci√≥n

Ansible nunca guarda los secretos desencriptados en el disco. Todo ocurre en la memoria RAM durante la ejecuci√≥n.

```mermaid
sequenceDiagram
    participant U as Usuario
    participant A as Ansible Engine
    participant V as Vault File (Cifrado)
    participant S as Servidor Remoto

    U->>A: Ejecuta ansible-playbook
    A->>U: üîí ¬øContrase√±a del Vault?
    U->>A: Ingresa contrase√±a
    A->>V: Lee archivo cifrado
    A->>A: Desencripta en Memoria RAM
    A->>S: Env√≠a configuraci√≥n (con el secreto ya plano)
    Note right of S: El servidor recibe el dato final,<br/>pero en Git sigue cifrado.
```

### üõ†Ô∏è Comandos Esenciales

Ansible incluye la herramienta `ansible-vault` de serie.

1.  **Crear un archivo cifrado:**
    ```bash
    ansible-vault create secrets.yml
    ```
2.  **Encriptar un archivo existente:**
    ```bash
    ansible-vault encrypt vars_plano.yml
    ```
3.  **Editar un archivo cifrado (lo abre, editas y lo vuelve a cifrar al cerrar):**
    ```bash
    ansible-vault edit secrets.yml
    ```
4.  **Ver contenido sin editar:**
    ```bash
    ansible-vault view secrets.yml
    ```

### üß™ Pr√°ctica: Usando Secretos en un Playbook

**Paso 1: Crear el almac√©n de secretos**
Crea un archivo `group_vars/all/secrets.yml` usando `ansible-vault create`:

```yaml
# Dentro del editor seguro
db_password: "SuperSecretPassword123!"
api_token: "x8z-999-token-secreto"
```

**Paso 2: Usar la variable en el Playbook**
En tu `site.yml`, usa la variable como cualquier otra:

```yaml
- name: Configurar Base de Datos
  hosts: dbservers
  tasks:
    - name: Crear usuario de BD
      mysql_user:
        name: admin
        password: "{{ db_password }}"  # <-- Ansible la inyectar√° aqu√≠
        priv: "*.*:ALL"
```

**Paso 3: Ejecutar**
```bash
ansible-playbook site.yml --ask-vault-pass
```

### üí° Pro Tip: Automatizaci√≥n (CI/CD)
En un pipeline (Jenkins, GitHub Actions) no hay un humano para escribir la contrase√±a.
Usa un archivo de contrase√±a protegido:

```bash
# 1. Crea un archivo con la clave (¬°A√ë√ÅDELO AL .GITIGNORE!)
echo "mi_contrase√±a_maestra" > .vault_pass

# 2. Ejecuta sin preguntar
ansible-playbook site.yml --vault-password-file .vault_pass
```

---

## 8.2. Jinja2 Templates: Archivos Din√°micos

Hasta ahora us√°bamos el m√≥dulo `copy` para subir archivos est√°ticos. Pero, ¬øy si cada servidor necesita una configuraci√≥n ligeramente diferente (su propia IP, su propio nombre)?

### üìù La Analog√≠a: "Mad Libs" o Carta Modelo
Imagina una carta del banco. No escriben una carta nueva para cada cliente. Tienen una plantilla:

```jinja
Hola {{ nombre_cliente }}, su saldo actual es de {{ saldo }} euros.
```

Ansible usa **Jinja2** (el motor de plantillas de Python) para rellenar esos huecos justo antes de subir el archivo al servidor.

### Sintaxis B√°sica

*   `{{ variable }}`: **Imprimir**. Sustituye esto por el valor de la variable.
*   `{% if ... %}`: **L√≥gica**. Control de flujo (condicionales, bucles).
*   `{# comentario #}`: Comentarios que no aparecer√°n en el archivo final.

### üß™ Pr√°ctica: HTML Din√°mico

Vamos a generar una p√°gina de inicio personalizada para cada servidor web que muestre informaci√≥n del sistema en tiempo real.

**1. El Template (`templates/index.j2`)**
Crea este archivo en tu m√°quina de control. F√≠jate en la extensi√≥n `.j2`.

```html
<!-- templates/index.j2 -->
<!DOCTYPE html>
<html>
<head>
    <title>Bienvenido a {{ ansible_hostname }}</title>
</head>
<body>
    <h1>Informaci√≥n del Servidor</h1>
    <p><strong>Hostname:</strong> {{ ansible_hostname }}</p>
    <p><strong>IP P√∫blica:</strong> {{ ansible_default_ipv4.address }}</p>
    <p><strong>Sistema Operativo:</strong> {{ ansible_distribution }} {{ ansible_distribution_version }}</p>

    <h2>Usuarios del Sistema (Generado por bucle)</h2>
    <ul>
    {% for user in usuarios_sistema %}
        <li>Usuario: {{ user }}</li>
    {% else %}
        <li>No hay usuarios definidos.</li>
    {% endfor %}
    </ul>

    <!-- L√≥gica condicional -->
    {% if app_env == 'production' %}
        <div style="color: red;">‚ö†Ô∏è ENTORNO DE PRODUCCI√ìN</div>
    {% else %}
        <div style="color: green;">‚úÖ Entorno de Desarrollo</div>
    {% endif %}
</body>
</html>
```

**2. El Playbook (`site.yml`)**

```yaml
- name: Desplegar Web Din√°mica
  hosts: webservers
  vars:
    app_env: production
    usuarios_sistema:
      - pablo
      - ana
      - admin
  
  tasks:
    - name: Generar index.html desde plantilla
      template:
        src: templates/index.j2
        dest: /var/www/html/index.html
        owner: www-data
        group: www-data
        mode: '0644'
```

### Resultado
Cuando ejecutes esto, Ansible:
1.  Leer√° `index.j2`.
2.  Sustituir√° `{{ ansible_hostname }}` por el nombre real de CADA m√°quina (ej: `web01`, `web02`).
3.  Generar√° la lista `<ul>` repitiendo el `<li>` 3 veces.
4.  Evaluar√° el `if` y pondr√° el aviso de "PRODUCCI√ìN".
5.  Subir√° el archivo resultante `.html` al servidor.

## Resumen
Con **Vault**, duermes tranquilo sabiendo que tus secretos est√°n cifrados. Con **Jinja2**, tus configuraciones se adaptan el√°sticamente a cualquier entorno. Juntos, convierten tus Playbooks en herramientas profesionales y seguras.
