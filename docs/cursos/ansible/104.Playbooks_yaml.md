---
title: Playbooks y YAML
sidebar_label: 4. Playbooks
---

# Playbooks y YAML üìú

El coraz√≥n de Ansible: definir el estado deseado de tu infraestructura.

:::info Video pendiente de grabaci√≥n
:::

## 4.1. Sintaxis YAML: La Regla de Oro

YAML (YAML Ain't Markup Language) es el lenguaje que usa Ansible. Es famoso por ser legible para humanos, pero estricto con las m√°quinas.

### üõí La Analog√≠a: La Lista de la Compra
Imagina una lista de la compra organizada por pasillos. No mezclas todo; agrupas las cosas para ser eficiente.

*   **Pasillo Fruter√≠a:**
    *   Manzanas
    *   Peras
*   **Pasillo Limpieza:**
    *   Lej√≠a
    *   Jab√≥n

En YAML, esta estructura visual es **obligatoria**.

### Diccionarios vs Listas

Hay dos estructuras clave que debes dominar:

1.  **Diccionarios (Mapas):** Pares `clave: valor`. Definen propiedades.
2.  **Listas (Arrays):** Elementos que empiezan con un guion `-`. Son colecciones.

```yaml
# Esto es un Diccionario (Propiedades de un coche)
coche:
  marca: Toyota
  modelo: Corolla
  color: Rojo

# Esto es una Lista (Cosas en el maletero)
maletero:
  - Rueda de repuesto
  - Gato hidr√°ulico
  - Tri√°ngulos
```

### ‚ö†Ô∏è La Regla de Oro de la Indentaci√≥n
En YAML, la jerarqu√≠a se define por la indentaci√≥n (espacios a la izquierda).

> **NUNCA uses tabuladores (Tabs). Usa siempre ESPACIOS (generalmente 2 por nivel).**

#### ‚úÖ BIEN (Espacios)
```yaml
hosts: webservers
tasks:
  - name: Instalar Nginx  # 2 espacios de indentaci√≥n
    apt:                  # 4 espacios
      name: nginx         # 6 espacios
```

#### ‚ùå MAL (Tabs o mezcla)
```yaml
hosts: webservers
tasks:
	- name: Instalar Nginx  # <--- ¬°ERROR! Tabulador detectado
    apt:
      name: nginx
```
*Si mezclas tabs y espacios, Ansible te odiar√° y el Playbook fallar√°.*

---

## 4.2. Estructura de un Playbook

Un **Playbook** es el archivo donde orquestamos todo. Tiene una jerarqu√≠a estricta.

### üé¨ La Analog√≠a: El Guion de Cine
*   **Playbook:** Es la pel√≠cula completa.
*   **Play:** Es una **Escena**. Ocurre en un lugar espec√≠fico (un grupo de `hosts`) y tiene unos actores (tareas).
*   **Task:** Es una **Acci√≥n** concreta del guion ("El actor abre la puerta").
*   **Module:** Es la **Herramienta** usada para la acci√≥n (La puerta, el pomo).

### Jerarqu√≠a Visual

```mermaid
mindmap
  root((Playbook))
    Play 1: Configurar Webservers
      Hosts: webservers
      Tasks
        Task 1: Instalar Nginx
          Module: apt
        Task 2: Copiar HTML
          Module: copy
    Play 2: Configurar DB
      Hosts: dbservers
      Tasks
        Task 1: Instalar MySQL
          Module: apt
```

### Anatom√≠a en C√≥digo

```yaml
# Playbook
- name: Play 1 - Configurar Servidores Web  # <-- PLAY
  hosts: webservers
  become: yes  # Usar sudo

  tasks:
    - name: Task 1 - Instalar paquete       # <-- TASK
      apt:                                  # <-- MODULE
        name: nginx
        state: present
```

---

## 4.3. M√≥dulos Esenciales (Los 4 Fant√°sticos)

Ansible tiene miles de m√≥dulos, pero usar√°s estos 4 el 80% del tiempo.

### 1. Gesti√≥n de Paquetes (`apt` / `yum`)
Instala, actualiza o elimina software.

```yaml
- name: Instalar git
  apt:
    name: git
    state: present  # Opciones: present (instalar), absent (borrar), latest (actualizar)
```

### 2. Gesti√≥n de Archivos (`copy`)
Sube archivos desde tu m√°quina de control al servidor remoto.

```yaml
- name: Subir archivo de configuraci√≥n
  copy:
    src: ./files/nginx.conf   # Origen (tu PC)
    dest: /etc/nginx/nginx.conf # Destino (Servidor remoto)
```

### 3. Gesti√≥n de Servicios (`service` / `systemd`)
Arranca, para o reinicia demonios.

```yaml
- name: Arrancar Nginx
  service:
    name: nginx
    state: started  # Opciones: started, stopped, restarted
    enabled: yes    # ¬øArrancar al inicio del sistema?
```

### 4. Gesti√≥n de Usuarios (`user`)
Crea o modifica usuarios del sistema.

```yaml
- name: Crear usuario deploy
  user:
    name: deploy
    shell: /bin/bash
    groups: sudo
```

### üí° El Concepto de Idempotencia
F√≠jate en el par√°metro `state`. En Ansible no decimos "Instala esto", decimos "Aseg√∫rate de que esto est√© **presente**".
*   Si no est√° -> Lo instala.
*   Si ya est√° -> **No hace nada**.

Esto es **Idempotencia**: Puedes ejecutar el mismo Playbook 1000 veces, y el resultado final siempre ser√° el mismo, sin romper nada.

---

## 4.4. Pr√°ctica: Tu Primer Servidor Web üåç

Vamos a crear el "Hola Mundo" de la infraestructura: Un servidor web Nginx con una p√°gina personalizada.

### El Playbook (`site.yml`)

Crea un archivo llamado `site.yml` con este contenido:

```yaml
---
- name: Configurar mi Servidor Web
  hosts: all  # O el grupo que tengas en tu inventario
  become: yes # Necesitamos root para instalar cosas

  tasks:
    - name: 1. Instalar Nginx
      apt:
        name: nginx
        state: present
        update_cache: yes # Equivalente a apt-get update

    - name: 2. Crear p√°gina web personalizada
      copy:
        dest: /var/www/html/index.html
        content: |
          <h1>¬°Hola desde Ansible! üöÄ</h1>
          <p>Este servidor ha sido configurado autom√°ticamente.</p>

    - name: 3. Asegurar que Nginx est√° corriendo
      service:
        name: nginx
        state: started
        enabled: yes
```

### Ejecuci√≥n

Lanza el playbook:
```bash
ansible-playbook -i inventario.ini site.yml
```

### üß™ Prueba de "Self-Healing" (Auto-curaci√≥n)

1.  Entra al servidor y **borra** el archivo index: `rm /var/www/html/index.html`.
2.  ¬°Oh no! La web ha desaparecido (error 403/404).
3.  **Vuelve a ejecutar el Playbook.**

Ver√°s que Ansible detecta que el archivo falta (Changed: 1) y lo vuelve a crear. **Ha reparado el sistema autom√°ticamente** para que coincida con tu definici√≥n de "estado deseado".
